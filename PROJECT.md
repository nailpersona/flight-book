# FLY-BOOK — Проект модернізації льотної книжки

## Мета проекту
Модернізація додатку обліку нальоту для льотного складу. Перехід з Google Sheets → Supabase з автоматичними розрахунками, ШІ-чатом по керівним документам та інформативним дашбордом.

Початково реалізуємо для **винищувальної авіації** (МиГ-29, Су-27, Л-39), потім донарощуватимемо по іншим напрямкам.

---

## Архітектура

```
┌─────────────────────┐     ┌──────────────────────┐
│   Мобільний додаток  │     │    Web Dashboard     │
│   (Expo/React Native)│     │    (Next.js)         │
│                     │     │                      │
│  Для льотчиків:     │     │  Для командування:   │
│  - Ввід польотів    │     │  - Стан БГ усіх      │
│  - Перерви за МУ    │     │    льотчиків          │
│  - Перерви за ЛП    │     │  - Графіки/аналітика │
│  - Комісування      │     │  - ШІ-чат            │
│  - Річні перевірки  │     │  - Адмін-панель      │
│  - ШІ-чат           │     │  - Звіти (Підсумки)  │
│  - Налаштування     │     │                      │
└────────┬────────────┘     └────────┬─────────────┘
         │                           │
         └──────────┬────────────────┘
                    │
            ┌───────▼────────┐
            │    Supabase    │
            │                │
            │  - Auth + RLS  │
            │  - PostgreSQL  │
            │  - pgvector    │
            │  - Edge Funcs  │
            │  - Realtime    │
            └────────────────┘
```

---

## Поточний стан (до модернізації)

**Стек:** React Native (Expo v54) + Google Apps Script + Google Sheets
**Файли:** App.js, Main.js, MyRecords.js, Profile.js, Login.js, BreaksMU.js, BreaksLP.js, CommissionTable.js, AdminUsers.js, AdminSettings.js, api.js

### Google Sheets "Облік нальоту" (6 листів):
1. **"Стан БГ"** — Головний дашборд (63 колонки): перерви МУ, перевірки ЛП, комісування, перерви ЛП
2. **"Main"** — Записи польотів (дата, ПІБ, тип ПС, МУ, роль, вид пол., наліт, примітки)
3. **"Підсумки"** — Зведення за період по типах ПС
4. **"Адмін"** — Форма створення користувачів
5. **"Users"** — email, ПІБ, role, salt, passwordHash
6. **"Sessions"** — token, email, expires

---

## Екрани мобільного додатку (нова версія)

### 1. Ввід польоту
Поля: Дата, Тип ПС, Час доби МУ, В якості кого, № вправи КБП, Вид польоту, К-ть польотів, Наліт, Бойових заст., Примітки

### 2. Перерви за МУ
6 метеоумов з кольоровою індикацією:
- ДПМУ, ДСМУ, ДВМП (день)
- НПМУ, НСМУ, НВМП (ніч)
Статус: 2=зелений(>15дн), 1=жовтий(<15дн), 0=червоний(прострочено)

### 3. Перерви за видами ЛП
По видах: складний пілотаж, малі висоти, ГМВ/ОНБ, бойове застосування, групова злітаність, десантування, тощо

### 4. Таблиця комісування
Аварійне залишення, Ст.205 ПРІАЗ, ЛЛК/УМО, Відпустка, Стрибки з парашутом

### 5. Річні перевірки
ТП, дублюючі прилади, імітація відмови двигуна, навігація, БЗ, інструкторська

### 6. ШІ-чат
Питання по керівним документам → відповідь з посиланнями на пункти

### 7. Налаштування
- Змінити пароль
- Типи ЛА (додати/видалити з випадаючих списків)
- Наліт по типах ЛА
- Класність

---

## Керівні документи

### В проекті (`docs/`):
| Файл | Документ | Що містить для системи |
|------|----------|----------------------|
| КБП ВА 2022.pdf | Курс бойової підготовки винищувальної авіації | Перерви за видами ЛП (Табл.1), річні перевірки, вправи, норми нальоту, нормативи оцінок |
| КЛПВ-24 еталон.docx | Курс льотної підготовки випробувачів 2024 | Перерви за видами ЛП (Додаток 1), терміни перевірок, навантаження в зміну |
| ПВП ДАУ наказ №2 від 05.01.2015.docx | Правила виконання польотів ДАУ | Загальні правила перерв та відновлення, норми нальоту/відпочинку |
| ПОЛОЖЕННЯ про ЛВР зі змінами.docx | Положення про льотно-випробувальну роботу | Правила відновлення в СМУ, стартовий час |
| Облік нальоту.xlsx | Поточна Google Sheets таблиця | Фактична модель даних та формули |

### Потрібні додатково:
- **Додаток 5 до ПВП ДАУ** — точна таблиця перерв за МУ (можливо є в зовнішньому .doc файлі)
- КБП інших типів авіації (при розширенні)

---

## Критичні бізнес-правила

### Перерви за МУ (з таблиці, встановлені командиром)
| МУ | 1 клас (дн) | 2 клас | 3 клас |
|----|-------------|--------|--------|
| ДПМУ | 107 | 92 | 76 |
| ДСМУ | 92 | 77 | 61 |
| ДВМП | 77 | 61 | 46 |
| НПМУ | 92 | 77 | 61 |
| НСМУ | 77 | 61 | 46 |
| НВМП | 61 | 46 | 30 |

### Ієрархія МУ (складніші зараховують простіші)
```
НВМП → НСМУ → НПМУ
  ↓       ↓       ↓
ДВМП → ДСМУ → ДПМУ
```
Тобто політ НВМП оновлює дату для ВСІХ метеоумов.

### Коефіцієнти
- Випробувачі 1 класу: 1.5x до допустимого терміну перерви
- Інструкторський політ подовжує перерву на 50% (макс 1.5x строку)

### Статуси (кольорова індикація)
- **2 (зелений)** — діє, > 15 днів до кінця
- **1 (жовтий)** — < 15 днів залишилось
- **0 (червоний)** — прострочено

### Відновлення після перерви
1. Перерва перевищена → **контрольний політ** → тренувальний не пізніше:
   - 20 діб (снайпер/1 клас)
   - 15 діб (2 клас)
   - 10 діб (3 клас)
2. Перерва > 2x від норми → **план введення до строю**
3. 1-2 клас випробувача → можуть без контрольних (за рішенням метод. ради)
4. Перерва > 6 міс на типі → заліки КЛЕ + тренаж в кабіні

### Типи польотів та їх вплив
| Тип польоту | Вплив на перерви |
|-------------|-----------------|
| У складі екіпажу | Тільки наліт, перерви НЕ оновлює |
| Контрольний | Початок відновлення, є час до тренувального |
| Тренувальний | Самостійний, повністю відновлює за вправами |
| Інструкторський | Подовжує перерву на 50% (макс 1.5x) |
| Вивізний | = тренувальний для цілей перерв |

### Перерви за видами ЛП (КБП ВА, Таблиця 1)
| Вид | Сн./1кл | 2кл | 3кл/б.к. |
|-----|---------|-----|----------|
| ПБ з винищувачами, складний пілотаж | 3 міс | 2 міс | 1 міс |
| ПБ у хмарах, пілотаж на ГМВ, атаки НЦ зі СВМ | 4 міс | 3 міс | 2 міс |
| Решта (атаки НЦ з ПВМ, ГЗ, малі висоти, надзвукові) | 6 міс | 5 міс | 4 міс |

### Комісування
| Категорія | Термін дії |
|-----------|-----------|
| Аварійне залишення | 365 дн |
| Ст. 205 ПРІАЗ | 184 дн |
| ЛЛК/УМО | 365 дн |
| Стрибки з парашутом | 1095 дн (3 роки) |

### Річні перевірки
| Перевірка | Сн./1-2кл | 3кл/б.к. |
|-----------|-----------|----------|
| ТП, навігація, БЗ | 12 міс | 12 міс |
| ТП за дублюючими | 12 міс | 6 міс |
| Відмова двигуна | 12 міс | 12 міс |
| Інструкторська | 12 міс | — |

---

## Схема бази даних Supabase (план)

### Таблиці:
- **users** — id, email, name, rank, position, military_class(1/2/3), test_class, coefficient, availability, created_at
- **user_aircraft** — user_id, aircraft_type (зв'язок багато-до-багатьох)
- **flights** — id, user_id, date, aircraft_type, mu_condition, role, kbp_exercise, flight_type, flights_count, flight_time, combat_sorties, notes, created_at
- **break_periods_mu** — конфігурація допустимих перерв за МУ по класах
- **break_periods_lp** — конфігурація перерв за видами ЛП по класах
- **commission_types** — конфігурація типів комісування з термінами
- **commission_dates** — user_id, commission_type_id, date
- **annual_checks** — user_id, check_type, date, result
- **documents** — id, title, content, embedding (pgvector для RAG)
- **document_chunks** — id, document_id, chunk_text, chunk_index, paragraph_ref, embedding

### Обчислювані поля (views/functions):
- Дата останнього польоту по кожній МУ (з урахуванням ієрархії)
- Статус перерв (0/1/2) для кожної МУ та виду ЛП
- Загальний наліт по типах ПС, за період
- Кількість днів до "випадання" з кожної МУ

---

## Етапи реалізації

| # | Етап | Опис |
|---|------|------|
| 1 | База даних | Створення схеми Supabase, міграції, RLS-політики |
| 2 | Auth | Supabase Auth замість Google Apps Script |
| 3 | API | Заміна api.js на Supabase client |
| 4 | Автоматичні розрахунки | DB functions/triggers для перерв, статусів, нальоту |
| 5 | Мобільний додаток | Оновлення існуючих екранів + нові (річні перевірки, налаштування) |
| 6 | Web Dashboard | Next.js: дашборд, адмін, звіти |
| 7 | ШІ-модуль | RAG: завантаження документів → pgvector → пошук → відповіді з посиланнями |
| 8 | Тестування | Міграція даних, верифікація розрахунків |
